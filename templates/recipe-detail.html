<?php include 'includes/header.php'; ?>
<link rel="stylesheet" href="assets/css/recipe-detail.css?v=3" />

<div class="recipe-detail-container">
  <!-- Recipe Header -->
  <div class="recipe-header">
    <span class="recipe-category-badge">
      <?php echo getCategoryEmoji($recipe['category']); ?>
      <?php echo htmlspecialchars(ucfirst($recipe['category'])); ?>
    </span>

    <h1 class="recipe-title">
      <?php echo htmlspecialchars($recipe['title']); ?>
    </h1>

    <div class="recipe-author-info">
      <span
        >ğŸ‘¤ By
        <?php echo htmlspecialchars($recipe['author_name']); ?></span
      >
      <span
        >ğŸ“…
        <?php echo date('F j, Y', strtotime($recipe['created_at'])); ?></span
      >
    </div>

    <div class="recipe-meta-grid">
      <?php if (isset($recipe['prep_time']) && $recipe['prep_time'] >
      0): ?>
      <div class="meta-item">
        <div class="meta-label">Prep Time</div>
        <div class="meta-value">
          <?php echo $recipe['prep_time']; ?>
          min
        </div>
      </div>
      <?php endif; ?>

      <?php if (isset($recipe['cook_time']) && $recipe['cook_time'] >
      0): ?>
      <div class="meta-item">
        <div class="meta-label">Cook Time</div>
        <div class="meta-value">
          <?php echo $recipe['cook_time']; ?>
          min
        </div>
      </div>
      <?php endif; ?>

      <?php if (isset($recipe['servings']) && $recipe['servings'] >
      0): ?>
      <div class="meta-item">
        <div class="meta-label">Servings</div>
        <div class="meta-value"><?php echo $recipe['servings']; ?></div>
      </div>
      <?php endif; ?>

      <?php if (isset($recipe['prep_time']) && isset($recipe['cook_time']) && $recipe['prep_time'] >
      0 && $recipe['cook_time'] > 0): ?>
      <div class="meta-item">
        <div class="meta-label">Total Time</div>
        <div class="meta-value">
          <?php echo $recipe['prep_time'] + $recipe['cook_time']; ?>
          min
        </div>
      </div>
      <?php endif; ?>
    </div>

    <?php if (isset($_SESSION['user_id']) && $_SESSION['user_id'] == $recipe['user_id']): ?>
    <div class="edit-delete-buttons">
      <a href="edit-recipe.php?id=<?php echo $recipe['id']; ?>" class="btn-edit"
        >âœï¸ Edit Recipe</a
      >
      <a
        href="delete-recipe.php?id=<?php echo $recipe['id']; ?>"
        class="btn-delete"
        onclick="return confirm('Are you sure you want to delete this recipe?')"
      >
        ğŸ—‘ï¸ Delete Recipe
      </a>
    </div>
    <?php endif; ?>
  </div>

  <!-- Recipe Image -->
  <div class="recipe-image-section">
    <?php if (isset($recipe['image']) && !empty($recipe['image'])): ?>
    <img
      src="<?php echo htmlspecialchars($recipe['image']); ?>"
      alt="<?php echo htmlspecialchars($recipe['title']); ?>"
      class="recipe-main-image"
    />
    <?php else: ?>
    <div class="no-image-placeholder">
      <?php echo getCategoryEmoji($recipe['category']); ?>
    </div>
    <?php endif; ?>
  </div>

  <!-- Recipe Content -->
  <div class="recipe-content">
    <!-- Description (if exists) -->
    <?php if (isset($recipe['description']) && !empty($recipe['description'])): ?>
    <div class="content-section description-section">
      <h2 class="section-title">ğŸ“ Description</h2>
      <p class="recipe-description">
        <?php echo nl2br(htmlspecialchars($recipe['description'])); ?>
      </p>
    </div>
    <?php endif; ?>

    <!-- Ingredients -->
    <div class="content-section">
      <h2 class="section-title">ğŸ¥• Ingredients</h2>
      <ul class="ingredients-list">
        <?php 
                $ingredients = explode("\n", $recipe['ingredients']);
                foreach ($ingredients as $ingredient): 
                    $ingredient = trim($ingredient);
                    if (!empty($ingredient)):
                ?>
        <li><?php echo htmlspecialchars($ingredient); ?></li>
        <?php 
                    endif;
                endforeach; 
                ?>
      </ul>
    </div>

    <!-- Instructions -->
    <div class="content-section">
      <h2 class="section-title">ğŸ‘¨â€ğŸ³ Instructions</h2>
      <ol class="instructions-list">
        <?php 
                $instructions = explode("\n", $recipe['instructions']);
                foreach ($instructions as $instruction): 
                    $instruction = trim($instruction);
                    if (!empty($instruction)):
                ?>
        <li><?php echo htmlspecialchars($instruction); ?></li>
        <?php 
                    endif;
                endforeach; 
                ?>
      </ol>
    </div>
  </div>

  <!-- Comments Section -->
  <div class="comments-section">
    <h2 class="section-title">ğŸ’¬ Comments (<?php echo count($comments); ?>)</h2>

    <?php if (isset($_SESSION['user_id'])): ?>
    <!-- Comment Form -->
    <form method="POST" action="" class="comment-form">
      <?php if (!empty($error)): ?>
      <div class="error-message"><?php echo htmlspecialchars($error); ?></div>
      <?php endif; ?>

      <?php if (!empty($success)): ?>
      <div class="success-message">
        <?php echo htmlspecialchars($success); ?>
      </div>
      <?php endif; ?>

      <textarea
        name="comment"
        class="comment-textarea"
        placeholder="Share your thoughts about this recipe..."
        required
      ></textarea>

      <button type="submit" class="btn-comment">Post Comment</button>
    </form>
    <?php else: ?>
    <div class="login-prompt">
      <p>Please <a href="login.php">login</a> to leave a comment</p>
    </div>
    <?php endif; ?>

    <!-- Comments List -->
    <?php if (count($comments) >
    0): ?>
    <div class="comments-list">
      <?php foreach ($comments as $comment): ?>
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">
            ğŸ‘¤
            <?php echo htmlspecialchars($comment['user_name']); ?>
          </span>
          <span class="comment-date">
            <?php echo date('F j, Y \a\t g:i A', strtotime($comment['created_at'])); ?>
          </span>
        </div>
        <p class="comment-text">
          <?php echo nl2br(htmlspecialchars($comment['comment'])); ?>
        </p>
      </div>
      <?php endforeach; ?>
    </div>
    <?php else: ?>
    <p class="no-comments">No comments yet. Be the first to comment! ğŸ‰</p>
    <?php endif; ?>
  </div>
</div>

<?php include 'includes/footer.php'; ?>
